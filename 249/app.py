import torch
import gradio as gr
from diffusers import OvisImagePipeline

# åŠ è½½æ¨¡å‹
print("Loading Ovis-Image model...")
pipe = OvisImagePipeline.from_pretrained("checkpoints/Ovis-Image-7B", torch_dtype=torch.bfloat16)
pipe.to("cuda")
print("Model loaded successfully!")

def generate_image(prompt, negative_prompt, num_steps, guidance_scale, seed):
    """
    ç”Ÿæˆå›¾åƒçš„å‡½æ•°
    
    Args:
        prompt: æ­£å‘æç¤ºè¯
        negative_prompt: è´Ÿå‘æç¤ºè¯
        num_steps: æ¨ç†æ­¥æ•°
        guidance_scale: å¼•å¯¼å¼ºåº¦
        seed: éšæœºç§å­
    
    Returns:
        ç”Ÿæˆçš„å›¾åƒ
    """
    try:
        # è®¾ç½®éšæœºç§å­ä»¥ä¿è¯å¯é‡å¤æ€§
        if seed != -1:
            generator = torch.Generator(device="cuda").manual_seed(seed)
        else:
            generator = None
        
        # ç”Ÿæˆå›¾åƒ
        image = pipe(
            prompt=prompt,
            negative_prompt=negative_prompt,
            num_inference_steps=num_steps,
            guidance_scale=guidance_scale,
            generator=generator
        ).images[0]
        
        return image
    except Exception as e:
        print(f"Error generating image: {e}")
        raise gr.Error(f"ç”Ÿæˆå›¾åƒæ—¶å‡ºé”™: {str(e)}")

# ç¤ºä¾‹æç¤ºè¯ - é’ˆå¯¹ Ovis-Image çš„æ–‡æœ¬æ¸²æŸ“èƒ½åŠ›ï¼ŒåŒ…å«ä¸­æ–‡æ–‡å­—ç”Ÿæˆ
examples = [
    [
        'ä¸€ä¸ªåˆ›æ„çš„ä¸­å›½æ–°å¹´æµ·æŠ¥è®¾è®¡ï¼Œé¡¶éƒ¨ç”¨æ¯›ç¬”å­—å†™ç€"æ–°å¹´å¿«ä¹"å››ä¸ªå¤§å­—ï¼Œçº¢è‰²æ¸å˜èƒŒæ™¯ï¼Œé‡‘è‰²çš„ä¹¦æ³•å­—ä½“ï¼Œå‘¨å›´æœ‰ç¥¥äº‘å’Œç¯ç¬¼è£…é¥°ï¼Œä¸‹æ–¹å°å­—"2025 é¾™å¹´å¤§å‰"ï¼Œå–œåº†çƒ­é—¹çš„æ°›å›´ï¼Œé«˜æ¸…ç»†èŠ‚',
        "æ¨¡ç³Šï¼Œä½è´¨é‡ï¼Œæ–‡å­—é”™è¯¯",
        50,
        5.0,
        42
    ],
    [
        'ä¸€ä¸ªç°ä»£ç®€çº¦çš„å’–å•¡åº—èœå•é»‘æ¿ï¼Œé¡¶éƒ¨ç”¨ç²‰ç¬”å­—å†™ç€"ä»Šæ—¥ç‰¹é¥®"ï¼Œä¸‹é¢åˆ—å‡ºï¼š\n"ç¾å¼å’–å•¡ - Â¥28"\n"æ‹¿é“ - Â¥32"\n"å¡å¸ƒå¥‡è¯º - Â¥35"\næ·±æ£•è‰²æœ¨è´¨èƒŒæ™¯ï¼Œæ¸©é¦¨çš„å’–å•¡åº—æ°›å›´ï¼Œæ‰‹å†™ç²‰ç¬”å­—ä½“',
        "æ‚ä¹±ï¼Œéš¾ä»¥è¾¨è®¤ï¼Œæ‹¼å†™é”™è¯¯",
        50,
        5.0,
        123
    ],
    [
        'ä¸€å¼ å¤å¤é£æ ¼çš„ç”µå½±æµ·æŠ¥ï¼Œå¤§æ ‡é¢˜"åŠŸå¤«ä¼ å¥‡"ç”¨é‡‘è‰²æè¾¹çš„æ¥·ä½“å­—ï¼Œå‰¯æ ‡é¢˜"ä¾ ä¹‹å¤§è€… ä¸ºå›½ä¸ºæ°‘"ï¼ŒèƒŒæ™¯æ˜¯ä¸­å›½å±±æ°´ç”»é£æ ¼ï¼Œæ­¦ä¾ æ°›å›´ï¼Œç»å…¸æµ·æŠ¥æ„å›¾ï¼Œé«˜è´¨é‡æ¸²æŸ“',
        "ç°ä»£é£æ ¼ï¼Œç®€çº¦ï¼ŒæŠ½è±¡",
        50,
        5.0,
        456
    ],
    [
        'ä¸€ä¸ªç§‘æŠ€å…¬å¸çš„Logoè®¾è®¡ï¼Œæ–‡å­—"æ™ºåˆ›æœªæ¥"ç”¨ç°ä»£å‡ ä½•å­—ä½“ï¼Œè“è‰²æ¸å˜æ•ˆæœï¼Œä¸‹æ–¹å°å­—"AI Â· åˆ›æ–° Â· ç§‘æŠ€"ï¼Œç™½è‰²èƒŒæ™¯ï¼Œä¸“ä¸šå“ç‰Œè®¾è®¡ï¼ŒçŸ¢é‡é£æ ¼ï¼Œæ¸…æ™°é”åˆ©',
        "åƒç´ åŒ–ï¼Œä¸šä½™ï¼Œæ‚ä¹±",
        50,
        5.0,
        789
    ],
    [
        'ä¸€ä¸ªéœ“è™¹ç¯æ‹›ç‰Œè®¾è®¡ï¼Œ"è¥ä¸šä¸­"ä¸‰ä¸ªå­—ç”¨ç²‰çº¢è‰²å’Œè“è‰²éœ“è™¹ç¯ç®¡ç»„æˆï¼Œå‘å…‰æ•ˆæœï¼Œæ·±è‰²ç –å¢™èƒŒæ™¯ï¼Œä¸‹æ–¹å°å­—"24å°æ—¶"ä¹Ÿæ˜¯éœ“è™¹ç¯ï¼Œå¤œæ™šéƒ½å¸‚æ°›å›´ï¼Œç…§ç‰‡çº§çœŸå®æ„Ÿ',
        "ç™½å¤©ï¼Œæ— å…‰æ•ˆï¼Œå¹³é¢",
        50,
        5.0,
        234
    ],
    [
        'ä¸€æœ¬å¤é£ä¹¦ç±çš„å°é¢è®¾è®¡ï¼Œæ ‡é¢˜"è¯—è¯é›†"ç”¨ä¼˜é›…çš„ç¹ä½“æ¥·ä¹¦å­—ä½“ï¼Œé‡‘è‰²çƒ«å°æ•ˆæœï¼Œå‰¯æ ‡é¢˜"å”è¯—å®‹è¯ç²¾é€‰"ç”¨å°ä¸€å·çš„å­—ä½“ï¼ŒèƒŒæ™¯æ˜¯å¤å…¸å·è½´çº¹ç†ï¼Œå¸¦æœ‰èŠ±çº¹è¾¹æ¡†ï¼Œå…¸é›…å¤§æ°”',
        "ç°ä»£ï¼Œç®€çº¦ï¼Œè‰²å½©é²œè‰³",
        50,
        5.0,
        567
    ],
    [
        'ä¸€ä¸ªå•†åŠ¡ä¿¡æ¯å›¾è¡¨è®¾è®¡ï¼Œé¡¶éƒ¨æ ‡é¢˜"äº”æ­¥æˆåŠŸæ³•åˆ™"ç”¨ç²—é»‘ä½“ï¼Œä¸‹é¢5ä¸ªç¼–å·ç‰ˆå—ç«–å‘æ’åˆ—ï¼š\n"1. è®¡åˆ’"\n"2. æ‰§è¡Œ"\n"3. åˆ†æ"\n"4. ä¼˜åŒ–"\n"5. åº†ç¥"\næ¯ä¸ªé…æœ‰å½©è‰²å›¾æ ‡ï¼Œä¸“ä¸šå•†åŠ¡æ¼”ç¤ºé£æ ¼ï¼Œæ¸…æ™°å¸ƒå±€',
        "æ‚ä¹±ï¼Œæ··ä¹±ï¼Œéš¾ä»¥é˜…è¯»",
        50,
        5.0,
        890
    ],
    [
        'ä¸€ä¸ªå¥¶èŒ¶åº—çš„å®£ä¼ æµ·æŠ¥ï¼Œå¤§æ ‡é¢˜"å¤æ—¥ç‰¹é¥®"ç”¨å¯çˆ±çš„åœ†ä½“å­—ï¼Œç²‰è‰²ç³»èƒŒæ™¯ï¼Œä¸‹æ–¹å†™ç€"ä¹°ä¸€é€ä¸€"ï¼Œå‘¨å›´æœ‰æ°´æœå’Œæ°”æ³¡è£…é¥°ï¼Œæ¸…æ–°ç”œç¾çš„é£æ ¼ï¼Œé«˜é¥±å’Œåº¦è‰²å½©',
        "æš—è‰²è°ƒï¼Œä¸¥è‚ƒï¼Œå•è°ƒ",
        50,
        5.0,
        345
    ],
    [
        'ä¸€ä¸ªæ‰‹æœºAPPçš„ç™»å½•ç•Œé¢è®¾è®¡ï¼Œé¡¶éƒ¨"æ¬¢è¿å›æ¥"ç”¨ç°ä»£æ— è¡¬çº¿å­—ä½“ï¼Œä¸‹é¢æ˜¯"æ‰‹æœºå·"å’Œ"å¯†ç "çš„è¾“å…¥æ¡†æ ‡ç­¾ï¼Œè“è‰²"ç™»å½•"æŒ‰é’®ï¼Œåº•éƒ¨å°å­—"å¿˜è®°å¯†ç ï¼Ÿ"ï¼ŒiOSé£æ ¼ï¼Œç®€æ´ç•Œé¢ï¼Œé«˜ä¿çœŸåŸå‹',
        "æ‚ä¹±ï¼Œè¿‡æ—¶ï¼Œåƒç´ åŒ–",
        50,
        5.0,
        678
    ],
    [
        'ä¸€ä¸ªè¡—å¤´æ¶‚é¸¦è‰ºæœ¯ä½œå“ï¼Œ"è¿½æ¢¦"ä¸¤ä¸ªå¤§å­—ç”¨å–·æ¼†æ¶‚é¸¦é£æ ¼ï¼Œå½©è‰²å­—æ¯ï¼ˆç²‰è‰²ã€é»„è‰²ã€é’è‰²ã€ç´«è‰²ï¼‰ï¼Œæœ‰æ»´æ¼†å’Œé£æº…æ•ˆæœï¼Œæ°´æ³¥å¢™èƒŒæ™¯ï¼Œç°ä»£è¡—å¤´è‰ºæœ¯ç¾å­¦ï¼ŒçœŸå®å–·æ¼†è´¨æ„Ÿ',
        "æ•´æ´ï¼Œä¼ä¸šé£ï¼Œæ­£å¼",
        50,
        5.0,
        901
    ],
    [
        'A creative 3D artistic render where the text "OVIS-IMAGE" is written in a bold, expressive handwritten brush style using thick, wet oil paint. Vibrant rainbow colors swirling together. Clean canvas background. Dynamic lighting, 4k detail.',
        "",
        50,
        5.0,
        111
    ]
]

# åˆ›å»º Gradio ç•Œé¢
with gr.Blocks(title="Ovis-Image Text-to-Image Generator") as demo:
    gr.Markdown(
        """
        # ğŸ¨ Ovis-Image: å¼ºå¤§çš„æ–‡æœ¬æ¸²æŸ“ AI å›¾åƒç”Ÿæˆå™¨
        
        **Ovis-Image** æ˜¯ä¸€ä¸ª 7B å‚æ•°çš„æ–‡æœ¬ç”Ÿæˆå›¾åƒæ¨¡å‹ï¼Œä¸“é—¨æ“…é•¿ï¼š
        - âœ¨ **é«˜è´¨é‡æ–‡æœ¬æ¸²æŸ“**ï¼šåœ¨å›¾åƒä¸­ç”Ÿæˆæ¸…æ™°ã€å‡†ç¡®çš„æ–‡å­—
        - ğŸ“ **æ–‡å­—å¯†é›†åœºæ™¯**ï¼šæµ·æŠ¥ã€æ¨ªå¹…ã€Logoã€UI ç•Œé¢ã€ä¿¡æ¯å›¾è¡¨
        - ğŸ¯ **è¯­ä¹‰ä¸€è‡´æ€§**ï¼šæ–‡å­—å†…å®¹ä¸è§†è§‰è®¾è®¡å®Œç¾ç»“åˆ
        - âš¡ **é«˜æ•ˆéƒ¨ç½²**ï¼š7B æ¨¡å‹è§„æ¨¡ï¼Œå•å¡å³å¯è¿è¡Œ
        
        åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„æç¤ºè¯ï¼Œæˆ–é€‰æ‹©ç¤ºä¾‹å¼€å§‹åˆ›ä½œï¼
        """
    )
    
    with gr.Row():
        with gr.Column(scale=1):
            prompt_input = gr.Textbox(
                label="æç¤ºè¯ (Prompt)",
                placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾åƒï¼Œç‰¹åˆ«æ˜¯å…¶ä¸­åŒ…å«çš„æ–‡å­—å†…å®¹...",
                lines=5,
                value=""
            )
            
            negative_prompt_input = gr.Textbox(
                label="è´Ÿå‘æç¤ºè¯ (Negative Prompt)",
                placeholder="æè¿°ä½ ä¸æƒ³åœ¨å›¾åƒä¸­å‡ºç°çš„å†…å®¹...",
                lines=2,
                value=""
            )
            
            with gr.Row():
                num_steps_slider = gr.Slider(
                    minimum=20,
                    maximum=100,
                    value=50,
                    step=1,
                    label="æ¨ç†æ­¥æ•° (Inference Steps)",
                    info="æ›´å¤šæ­¥æ•°é€šå¸¸äº§ç”Ÿæ›´å¥½è´¨é‡ï¼Œä½†é€Ÿåº¦æ›´æ…¢"
                )
                
                guidance_scale_slider = gr.Slider(
                    minimum=1.0,
                    maximum=15.0,
                    value=5.0,
                    step=0.5,
                    label="å¼•å¯¼å¼ºåº¦ (Guidance Scale)",
                    info="æ›´é«˜çš„å€¼ä½¿ç”Ÿæˆæ›´è´´è¿‘æç¤ºè¯"
                )
            
            seed_input = gr.Number(
                label="éšæœºç§å­ (Seed)",
                value=-1,
                precision=0,
                info="è®¾ç½®ä¸º -1 ä½¿ç”¨éšæœºç§å­ï¼Œå…¶ä»–å€¼å¯é‡ç°ç»“æœ"
            )
            
            generate_btn = gr.Button("ğŸ¨ ç”Ÿæˆå›¾åƒ", variant="primary", size="lg")
        
        with gr.Column(scale=1):
            output_image = gr.Image(
                label="ç”Ÿæˆçš„å›¾åƒ",
                type="pil",
                height=600
            )
    
    # ç¤ºä¾‹åŒºåŸŸ
    gr.Markdown("## ğŸ“š ç¤ºä¾‹æç¤ºè¯")
    gr.Markdown("ç‚¹å‡»ä¸‹æ–¹ç¤ºä¾‹å¿«é€Ÿå¼€å§‹ï¼Œè¿™äº›ç¤ºä¾‹å±•ç¤ºäº† Ovis-Image åœ¨ä¸åŒæ–‡æœ¬æ¸²æŸ“åœºæ™¯ä¸‹çš„èƒ½åŠ›ï¼š")
    
    gr.Examples(
        examples=examples,
        inputs=[prompt_input, negative_prompt_input, num_steps_slider, guidance_scale_slider, seed_input],
        outputs=output_image,
        fn=generate_image,
        cache_examples=False,
        label="ç¤ºä¾‹ç”»å»Š"
    )
    
    # ç»‘å®šç”ŸæˆæŒ‰é’®
    generate_btn.click(
        fn=generate_image,
        inputs=[prompt_input, negative_prompt_input, num_steps_slider, guidance_scale_slider, seed_input],
        outputs=output_image
    )
    
    gr.Markdown(
        """
        ---
        ### ğŸ’¡ ä½¿ç”¨æŠ€å·§
        - **æ–‡å­—æ¸²æŸ“**ï¼šåœ¨æç¤ºè¯ä¸­æ˜ç¡®æŒ‡å®šè¦æ˜¾ç¤ºçš„æ–‡å­—å†…å®¹ï¼Œç”¨å¼•å·æ‹¬èµ·æ¥
        - **å­—ä½“é£æ ¼**ï¼šæè¿°å­—ä½“ç±»å‹ï¼ˆå¦‚ bold, serif, handwritten, neon ç­‰ï¼‰
        - **å¸ƒå±€è®¾è®¡**ï¼šè¯´æ˜æ–‡å­—çš„ä½ç½®ã€å¤§å°ã€é¢œè‰²å’Œæ’ç‰ˆ
        - **åº”ç”¨åœºæ™¯**ï¼šæµ·æŠ¥ã€Logoã€UI ç•Œé¢ã€èœå•ã€æ ‡ç‰Œã€ä¿¡æ¯å›¾ç­‰åœºæ™¯æ•ˆæœæœ€ä½³
        """
    )

# å¯åŠ¨åº”ç”¨
if __name__ == "__main__":
    demo.launch(
        server_name="0.0.0.0",
        server_port=7860,
        share=False,
        show_error=True
    )
